<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web NFC è®€å–å™¨ - ç¨‹å¼å¤¥ä¼´</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®šå­—é«”ç‚º Inter */
        :root {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-lg bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Web NFC è®€å–èˆ‡å¯«å…¥</h1>
        <p class="text-gray-500 mb-6">é»æ“ŠæŒ‰éˆ•ï¼Œç„¶å¾Œå°‡æ‚¨çš„æ‰‹æ©Ÿé è¿‘ NFC æ¨™ç±¤æˆ–å¡ç‰‡ã€‚</p>

        <!-- ç‹€æ…‹é¡¯ç¤ºå€ -->
        <div id="status-display" class="p-3 mb-6 rounded-lg bg-blue-100 text-blue-800 font-medium text-sm transition-all duration-300 shadow-inner">
            ç­‰å¾…æ‚¨æŒ‰ä¸‹ã€Œé–‹å§‹è®€å–ã€æˆ–ã€Œé–‹å§‹å¯«å…¥ã€...
        </div>

        <!-- è®€å–åŠŸèƒ½å€å¡Š -->
        <button id="scan-button" class="w-full px-5 py-3 mb-4 bg-indigo-600 text-white text-lg font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-300 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 active:scale-95">
            é–‹å§‹è®€å– NFC
        </button>

        <!-- å¯«å…¥åŠŸèƒ½å€å¡Š -->
        <div class="mt-8 pt-4 border-t border-gray-200">
            <h2 class="text-xl font-bold text-gray-800 mb-3">å¯«å…¥ NDEF è³‡æ–™ (ç´”æ–‡å­—)</h2>
            <textarea id="write-data-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" rows="3" placeholder="è¼¸å…¥è¦å¯«å…¥å¡ç‰‡çš„ç´”æ–‡å­—å…§å®¹..."></textarea>
            
            <button id="write-button" class="w-full mt-3 px-5 py-3 bg-red-600 text-white text-lg font-semibold rounded-lg shadow-lg hover:bg-red-700 transition duration-300 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50 active:scale-95 disabled:bg-red-300">
                é–‹å§‹å¯«å…¥ NFC
            </button>
        </div>
        
        <!-- è®€å–çµæœå€ -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-gray-800 mb-3 border-b pb-1">è®€å–åˆ°çš„è³‡æ–™ç´€éŒ„</h2>
            <div id="results-log" class="space-y-4">
                <p class="text-gray-500 text-sm italic">ç›®å‰æ²’æœ‰ç´€éŒ„ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        // ç²å– DOM å…ƒç´ 
        const scanButton = document.getElementById('scan-button');
        const writeButton = document.getElementById('write-button');
        const writeDataInput = document.getElementById('write-data-input');
        const statusDisplay = document.getElementById('status-display');
        const resultsLog = document.getElementById('results-log');
        let nfcReader = null; // ç”¨ä¾†å„²å­˜ NDEFReader å¯¦ä¾‹

        // API Key (åœ¨æ­¤æ‡‰ç”¨ä¸­ä¸ä½¿ç”¨ API Keyï¼Œä½†ç‚ºéµå®ˆè¦ç¯„ä¿ç•™)
        const apiKey = ""; 

        /**
         * æ›´æ–°ç‹€æ…‹è¨Šæ¯å’Œæ¨£å¼
         * @param {string} message è¦é¡¯ç¤ºçš„è¨Šæ¯
         * @param {'info' | 'success' | 'warning' | 'error'} type è¨Šæ¯é¡å‹
         */
        function updateStatus(message, type = 'info') {
            const classes = {
                'info': 'bg-blue-100 text-blue-800',
                'success': 'bg-green-100 text-green-800',
                'warning': 'bg-yellow-100 text-yellow-800',
                'error': 'bg-red-100 text-red-800'
            };
            
            // é‡è¨­æ¨£å¼ä¸¦æ‡‰ç”¨æ–°çš„æ¨£å¼
            statusDisplay.className = `p-3 mb-6 rounded-lg font-medium text-sm transition-all duration-300 shadow-inner ${classes[type] || classes.info}`;
            statusDisplay.textContent = message;
        }

        /**
         * å°‡è®€å–åˆ°çš„ç´€éŒ„å…§å®¹é¡¯ç¤ºåœ¨çµæœå€
         * @param {string} title ç´€éŒ„æ¨™é¡Œ
         * @param {string} content ç´€éŒ„å…§å®¹
         */
        function appendResult(title, content) {
            const logItem = document.createElement('div');
            logItem.className = 'p-3 bg-gray-50 border border-gray-200 rounded-md shadow-sm';
            logItem.innerHTML = `
                <p class="text-sm font-semibold text-gray-700">${title}</p>
                <code class="block mt-1 p-2 text-xs bg-white border border-dashed border-gray-300 rounded overflow-x-auto whitespace-pre-wrap">${content}</code>
            `;
            resultsLog.prepend(logItem); // æ–°çš„ç´€éŒ„æ”¾åœ¨æœ€å‰é¢
        }

        /**
         * å˜—è©¦å°‡ NDEF ç´€éŒ„çš„ payload (æœ‰æ•ˆè² è¼‰) è½‰æ›ç‚ºå¯è®€çš„å­—ä¸²
         * @param {DataView} dataView NDEF ç´€éŒ„çš„è³‡æ–™è¦–åœ–
         * @param {string} recordType ç´€éŒ„é¡å‹
         * @returns {string} è½‰æ›å¾Œçš„å­—ä¸²
         */
        function getPayloadAsString(dataView, recordType) {
            try {
                const buffer = new Uint8Array(dataView.buffer);
                
                // è™•ç† Text ç´€éŒ„ (TNF 1, RTD 'T')
                if (recordType === 'text/plain') {
                    // Text ç´€éŒ„çš„ç¬¬ä¸€å€‹ä½å…ƒçµ„æ˜¯ç‹€æ…‹ä½å…ƒçµ„ (åŒ…å«ç·¨ç¢¼å’Œèªè¨€é•·åº¦)
                    const languageCodeLength = buffer[0] & 0x3F; // å–å¾—èªè¨€ä»£ç¢¼é•·åº¦
                    const textContent = new TextDecoder().decode(buffer.slice(1 + languageCodeLength));
                    return `Text: "${textContent}"`;
                }

                // è™•ç† URL ç´€éŒ„ (TNF 1, RTD 'U')
                if (recordType === 'text/uri') {
                    // URL ç´€éŒ„çš„ç¬¬ä¸€å€‹ä½å…ƒçµ„æ˜¯ URI è­˜åˆ¥ç¢¼ä»£ç¢¼ (Prefix)
                    const prefixCode = buffer[0];
                    const urlSuffix = new TextDecoder().decode(buffer.slice(1));
                    
                    // NDEF URL Prefix å°æ‡‰è¡¨ (åƒ…åˆ—èˆ‰å¸¸è¦‹çš„)
                    const prefixes = [
                        "", "http://www.", "https://www.", "http://", "https://", 
                        "tel:", "mailto:", "ftp://anonymous:anonymous@", "ftp://ftp."
                    ];
                    
                    const url = prefixes[prefixCode] !== undefined ? prefixes[prefixCode] + urlSuffix : `(æœªçŸ¥å‰ç¶´ä»£ç¢¼ ${prefixCode})` + urlSuffix;
                    return `URL: "${url}"`;
                }
                
                // è™•ç†å…¶ä»–é¡å‹ (ä¾‹å¦‚ JSON, å…¶ä»– MIME é¡å‹)
                const text = new TextDecoder('utf-8').decode(buffer);
                return text;

            } catch (error) {
                console.error("Payload è§£æéŒ¯èª¤:", error);
                return `[ç„¡æ³•è§£æçš„è³‡æ–™] éŒ¯èª¤: ${error.message}`;
            }
        }

        /**
         * è™•ç†æˆåŠŸçš„ NFC è®€å–äº‹ä»¶
         * @param {NDEFReadingEvent} event è®€å–äº‹ä»¶ç‰©ä»¶
         */
        function handleReading(event) {
            updateStatus('âœ… è®€å–æˆåŠŸï¼æ­£åœ¨è§£æè³‡æ–™...', 'success');
            
            // æ¸…ç©ºèˆŠçš„ç´€éŒ„
            resultsLog.innerHTML = '';
            
            const message = event.message;
            let recordCount = 0;

            // è¿­ä»£ NDEF è¨Šæ¯ä¸­çš„æ‰€æœ‰ç´€éŒ„
            for (const record of message.records) {
                recordCount++;
                let payloadString = 'ç„¡æ³•è§£æ (é Text/URL/MIME é¡å‹æˆ–ç‚ºç©º)';
                
                // æª¢æŸ¥æ˜¯å¦æœ‰ payload (æœ‰æ•ˆè² è¼‰)
                if (record.data) {
                    // ç´€éŒ„çš„é¡å‹ (type) é€šå¸¸æœƒæ˜¯ 'text/plain', 'text/uri', æˆ– MIME é¡å‹ 'application/json' ç­‰
                    const recordType = record.recordType === 'mime' ? record.mediaType : record.recordType;
                    
                    // ä½¿ç”¨ DataView è™•ç†äºŒé€²åˆ¶è³‡æ–™
                    const dataView = new DataView(record.data.buffer);
                    payloadString = getPayloadAsString(dataView, recordType);
                }

                appendResult(
                    `ç´€éŒ„ ${recordCount} (é¡å‹: ${record.recordType})`,
                    `
                    **é¡å‹ç´°ç¯€**: ${record.recordType === 'mime' ? record.mediaType : record.recordType}\n
                    **è¨˜éŒ„ ID**: ${record.id || 'ç„¡'}\n
                    **è§£æå…§å®¹**: ${payloadString}`
                );
            }

            if (recordCount === 0) {
                 appendResult(
                    `è®€å–å®Œæˆ`,
                    `æ¨™ç±¤å·²è®€å–ï¼Œä½† NDEF è¨Šæ¯ä¸­æ²’æœ‰ä»»ä½•å¯ç”¨çš„ç´€éŒ„ (0 ç´€éŒ„)ã€‚`
                );
            }

            // è®€å–æˆåŠŸå¾Œï¼Œåœæ­¢æƒæ (å¯ä»¥æ‰‹å‹•å†æ¬¡é»æ“Šé–‹å§‹)
            stopScan();
        }

        /**
         * åœæ­¢ NFC æƒæ (ç”¨æ–¼è®€å–åŠŸèƒ½)
         */
        function stopScan() {
             if (nfcReader) {
                // ç§»é™¤ visibilitychange ç›£è½å™¨
                document.removeEventListener("visibilitychange", stopScan, { once: true });
                nfcReader = null; 
            }
            scanButton.textContent = 'é‡æ–°é–‹å§‹è®€å– NFC';
            scanButton.disabled = false;
        }

        /**
         * å•Ÿå‹• NFC è®€å–æµç¨‹
         */
        async function startNFCReading() {
            // æª¢æŸ¥ Web NFC API æ”¯æ´æ€§
            if (!('NDEFReader' in window)) {
                updateStatus('ğŸš« æ­¤ç€è¦½å™¨æˆ–é€£ç·šå”å®šä¸æ”¯æ´ Web NFC APIã€‚è«‹ç¢ºä¿ï¼š\n1. æ‚¨ä½¿ç”¨æœ€æ–°ç‰ˆçš„ Android Chrome æˆ– Edge ç€è¦½å™¨ã€‚\n2. ç¶²é æ˜¯é€é **HTTPS** å­˜å–çš„ã€‚', 'error');
                return;
            }

            // ç¦ç”¨è®€å–æŒ‰éˆ•ä¸¦æ›´æ–°ç‹€æ…‹
            scanButton.textContent = 'æ­£åœ¨ç­‰å¾…æ„Ÿæ‡‰... (é»æ“Šåœæ­¢)';
            scanButton.disabled = true;

            // å…è¨±ä½¿ç”¨è€…é»æ“Šå·²ç¦ç”¨çš„æŒ‰éˆ•ä¾†åœæ­¢æƒæ (é‡æ–°å•Ÿç”¨æŒ‰éˆ•)
            scanButton.onclick = stopScan;

            // æ¸…ç©ºèˆŠçš„çµæœ
            resultsLog.innerHTML = '<p class="text-gray-500 text-sm italic">è«‹é è¿‘ NFC æ¨™ç±¤ä»¥é€²è¡Œè®€å–...</p>';
            
            try {
                // å»ºç«‹ NDEFReader å¯¦ä¾‹
                nfcReader = new NDEFReader();

                // è¨»å†Šäº‹ä»¶è™•ç†å™¨
                nfcReader.onreading = handleReading;
                nfcReader.onerror = (error) => {
                    updateStatus(`âŒ è®€å–æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}.`, 'error');
                    console.error("NFC è®€å–éŒ¯èª¤:", error);
                    stopScan();
                };

                // å•Ÿå‹•æƒæ
                await nfcReader.scan(); 

                // é¦–æ¬¡æˆåŠŸå‘¼å« scan() æ„å‘³è‘— NFC è®€å–å™¨å·²æº–å‚™å°±ç·’
                updateStatus('ğŸ”” è®€å–å™¨å·²å•Ÿå‹•ã€‚è«‹å°‡æ‰‹æ©Ÿé è¿‘å¡ç‰‡...', 'info');

                // ç‚ºäº†ç”¨æˆ¶é«”é©—ï¼Œç•¶ä½¿ç”¨è€…åˆ‡æ›æ‡‰ç”¨ç¨‹å¼æˆ–è¢å¹•é—œé–‰æ™‚ï¼Œæœ€å¥½åœæ­¢æƒæ
                document.addEventListener("visibilitychange", stopScan, { once: true });

            } catch (error) {
                // è™•ç†æ¬Šé™è¢«æ‹’çµ•æˆ–è£ç½®æœªé–‹å•Ÿ NFC ç­‰éŒ¯èª¤
                updateStatus(`âŒ å•Ÿå‹• NFC å¤±æ•—: ${error.message}. è«‹æª¢æŸ¥æ‚¨çš„è£ç½®è¨­å®šå’Œæ¬Šé™ã€‚`, 'error');
                scanButton.textContent = 'é‡æ–°é–‹å§‹è®€å– NFC';
                scanButton.disabled = false;
            }
        }
        
        /**
         * å•Ÿå‹• NFC å¯«å…¥æµç¨‹
         */
        async function writeNFC() {
            if (!('NDEFReader' in window)) {
                updateStatus('ğŸš« æ­¤ç€è¦½å™¨æˆ–é€£ç·šå”å®šä¸æ”¯æ´ Web NFC APIã€‚è«‹ç¢ºèªç’°å¢ƒã€‚', 'error');
                return;
            }

            const dataToWrite = writeDataInput.value.trim();
            if (!dataToWrite) {
                updateStatus('âš ï¸ è«‹åœ¨æ–‡å­—æ¡†ä¸­è¼¸å…¥è¦å¯«å…¥çš„å…§å®¹ã€‚', 'warning');
                return;
            }

            // ç¦ç”¨å¯«å…¥æŒ‰éˆ•
            writeButton.textContent = 'æ­£åœ¨ç­‰å¾…æ„Ÿæ‡‰ä»¥å¯«å…¥...';
            writeButton.disabled = true;

            try {
                // 1. å»ºç«‹ NDEFReader å¯¦ä¾‹ (ç”¨æ–¼å¯«å…¥)
                const writer = new NDEFReader();
                
                // 2. å»ºç«‹è¦å¯«å…¥çš„ NDEF è¨Šæ¯ (è¨­å®šç‚ºç´”æ–‡å­—ç´€éŒ„)
                const message = {
                    records: [{
                        recordType: "text",
                        data: dataToWrite,
                        // èªè¨€ä»£ç¢¼ï¼Œä¾‹å¦‚ 'zh-TW'
                        lang: 'zh-TW' 
                    }]
                };

                // 3. å‘¼å« write() å•Ÿå‹•å¯«å…¥æµç¨‹
                updateStatus('ğŸ“¢ å¯«å…¥å™¨å·²å•Ÿå‹•ã€‚è«‹å°‡æ‰‹æ©Ÿé è¿‘å¡ç‰‡é€²è¡Œå¯«å…¥...', 'info');
                
                await writer.write(message);

                updateStatus(`âœ… å¯«å…¥æˆåŠŸï¼è³‡æ–™ "${dataToWrite.substring(0, 20)}..." å·²å„²å­˜åˆ° NFC æ¨™ç±¤ä¸Šã€‚`, 'success');
                // å¯«å…¥æˆåŠŸå¾Œï¼Œæ¸…ç©ºè¼¸å…¥æ¡†ï¼Œä¿æŒä»‹é¢æ•´æ½”
                writeDataInput.value = '';

            } catch (error) {
                let errorMessage = `âŒ å¯«å…¥å¤±æ•—: ${error.message}`;

                // **é€™æ˜¯åˆ¤æ–·æ˜¯å¦å”¯è®€çš„é—œéµï¼šNotWritableError**
                if (error.name === 'NotWritableError') {
                    errorMessage = 'ğŸ”’ å¯«å…¥å¤±æ•—: æ­¤ NFC æ¨™ç±¤æ˜¯**å”¯è®€ (Read-Only)** ç‹€æ…‹ï¼Œç„¡æ³•å¯«å…¥æˆ–é‡æ–°å¯«å…¥ã€‚';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = 'ğŸš« å¯«å…¥å¤±æ•—: æ­¤æ¨™ç±¤é¡å‹ä¸æ”¯æ´ NDEF å¯«å…¥ã€‚';
                } else if (error.name === 'SecurityError') {
                    errorMessage = 'âš ï¸ å¯«å…¥å¤±æ•—: å¿…é ˆé€é **HTTPS** å­˜å–ç¶²é ï¼Œä¸¦ç¢ºä¿ NFC æ¬Šé™å·²æˆäºˆã€‚';
                } else if (error.name === 'AbortError') {
                    // é€šå¸¸æ˜¯ä½¿ç”¨è€…ç§»å‹•æ‰‹æ©Ÿéå¿«æˆ–å–æ¶ˆäº†æ“ä½œ
                    errorMessage = 'ğŸ›‘ å¯«å…¥ä¸­æ­¢: å¯èƒ½æ˜¯æ‚¨ç§»å‹•æ‰‹æ©Ÿéå¿«ï¼Œè«‹é‡è©¦ã€‚';
                }
                
                updateStatus(errorMessage, 'error');
                console.error("NFC å¯«å…¥éŒ¯èª¤:", error);

            } finally {
                // é‡è¨­å¯«å…¥æŒ‰éˆ•ç‹€æ…‹
                writeButton.textContent = 'é–‹å§‹å¯«å…¥ NFC';
                writeButton.disabled = false;
            }
        }
        
        // åˆå§‹åŒ–æ™‚ï¼Œè¨­å®šè®€å–å’Œå¯«å…¥æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
        scanButton.onclick = startNFCReading;
        writeButton.onclick = writeNFC;

        // é¦–æ¬¡æª¢æŸ¥æ”¯æ´æ€§ä¸¦æ›´æ–°åˆå§‹ç‹€æ…‹
        window.onload = () => {
             if ('NDEFReader' in window) {
                updateStatus('âœ… Web NFC API å·²è¢«ç€è¦½å™¨æ”¯æ´ã€‚è«‹é–‹å§‹è®€å–æˆ–å¯«å…¥ã€‚', 'success');
            } else {
                updateStatus('ğŸš« æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web NFC APIã€‚è«‹ä½¿ç”¨æœ€æ–°ç‰ˆçš„ Android Chrome æˆ– Edge ç€è¦½å™¨ä¸¦é€é HTTPS å­˜å–ã€‚', 'error');
                scanButton.disabled = true;
                writeButton.disabled = true;
            }
        };

    </script>
</body>
</html>