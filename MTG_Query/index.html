<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG å¡ç‰Œå¿«é€ŸæŸ¥è©¢å™¨</title>
    <!-- è¼‰å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®šè‡ªè¨‚å­—é«”å’ŒèƒŒæ™¯ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* æ·±è‰²èƒŒæ™¯ */
        }
        .card-container {
            /* æ¨¡æ“¬ 63x88mm å¡ç‰Œçš„é•·å¯¬æ¯”ï¼Œä»¥ä¾¿ç”¨æˆ¶å°ç„¦ */
            aspect-ratio: 63 / 88;
            max-width: 350px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            border: 4px solid #f6e05e; /* é‡‘è‰²é‚Šæ¡† */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        video, canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* ç¢ºä¿è¦–è¨Šå¡«æ»¿å®¹å™¨ */
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center text-white mb-6">ğŸ”® MTG å¡ç‰ŒæŸ¥è©¢åŠ©æ‰‹ ğŸ’³</h1>
        <p class="text-center text-gray-400 mb-8">è«‹å°‡å¡ç‰Œæ¨™é¡Œå°æº–ä¸‹æ–¹çš„é‡‘è‰²æ¡†ç·šå€åŸŸï¼Œç„¶å¾Œé»æ“Šã€Œè¾¨è­˜å¡ç‰Œã€æŒ‰éˆ•ã€‚</p>

        <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å€åŸŸ -->
        <div class="flex flex-col lg:flex-row gap-8">
            
            <!-- 1. å½±åƒæ“·å–å€åŸŸ -->
            <div class="flex flex-col items-center flex-1 lg:max-w-sm mx-auto">
                <div id="webcam-container" class="card-container bg-gray-800 rounded-xl">
                    <!-- è¦–è¨Šä¸²æµå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                    <video id="webcam" autoplay playsinline class="rounded-xl"></video>
                    <!-- ç”¨æ–¼æ“·å–å½±åƒçš„ Canvas (éš±è—) -->
                    <canvas id="snapshot-canvas" style="display: none;"></canvas>
                    <div id="loading-overlay" class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-white text-lg font-semibold">æ­£åœ¨è¾¨è­˜å¡ç‰Œ...</span>
                    </div>
                </div>

                <button id="snapshot-btn" onclick="handleScan()"
                        class="mt-6 w-full max-w-xs px-6 py-3 bg-yellow-500 text-gray-900 font-extrabold rounded-lg shadow-lg hover:bg-yellow-400 transition transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
                    ğŸ“· è¾¨è­˜å¡ç‰Œ
                </button>

                <p id="status-message" class="mt-4 text-center text-gray-300 min-h-6">ç­‰å¾…ç›¸æ©Ÿå•Ÿå‹•...</p>
            </div>

            <!-- 2. çµæœé¡¯ç¤ºå€åŸŸ -->
            <div class="flex-1 bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                <h2 id="card-name-display" class="text-2xl font-semibold text-white mb-4 border-b pb-2 border-gray-700">æŸ¥è©¢çµæœ</h2>
                
                <div id="version-options" class="space-y-3">
                    <p class="text-gray-500">ç•¶æ‚¨æˆåŠŸè¾¨è­˜å¡ç‰Œå¾Œï¼Œé€™è£¡å°‡é¡¯ç¤ºæ‰€æœ‰ç‰ˆæœ¬é¸é …ã€‚</p>
                </div>
            </div>
        </div>
        
        <!-- API å¯†é‘°æ³¨æ„äº‹é … -->
        <div class="mt-10 p-4 bg-red-800 bg-opacity-30 rounded-lg text-sm text-red-200 border border-red-700">
            **é‡è¦æé†’ï¼š** ç‚ºäº†åœ¨ç€è¦½å™¨ä¸­ç›´æ¥é€²è¡Œ OCRï¼Œæˆ‘å€‘ä½¿ç”¨äº† Gemini APIã€‚åœ¨å¯¦éš›çš„ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œç‚ºäº†ä¿è­·æ‚¨çš„ API å¯†é‘°ï¼Œå¼·çƒˆå»ºè­°ä½¿ç”¨ä¼ºæœå™¨ç«¯ä»£ç† (Server-Side Proxy) ä¾†è™•ç† Google Cloud Vision API çš„å‘¼å«ã€‚
        </div>
    </div>

    <!-- JavaScript é‚è¼¯ -->
    <script type="module">
        // --------------------------------------------------------
        // 1. Firebase å’Œ API è¨­å®š (Canvas ç’°å¢ƒå°ˆç”¨)
        // --------------------------------------------------------
        // ç¨‹å¼ç¢¼ä¸­æœƒä½¿ç”¨ Canvas ç’°å¢ƒæä¾›çš„å…¨åŸŸè®Šæ•¸ __app_id, __firebase_config, __initial_auth_token
        
        const API_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=`;
        const SCRYFALL_API_URL = "https://api.scryfall.com/cards/search?q=";

        // --------------------------------------------------------
        // 2. DOM å…ƒç´  & ç‹€æ…‹ç®¡ç†
        // --------------------------------------------------------
        const webcam = document.getElementById('webcam');
        const canvas = document.getElementById('snapshot-canvas');
        const statusMessage = document.getElementById('status-message');
        const snapshotBtn = document.getElementById('snapshot-btn');
        const versionOptions = document.getElementById('version-options');
        const cardNameDisplay = document.getElementById('card-name-display');
        const loadingOverlay = document.getElementById('loading-overlay');
        let stream = null;

        // --------------------------------------------------------
        // 3. ç›¸æ©ŸåŠŸèƒ½
        // --------------------------------------------------------

        /** * å•Ÿå‹•ç¶²è·¯æ”å½±æ©Ÿ
         * å˜—è©¦å¾Œç½®é¡é ­ (environment) -> å˜—è©¦å‰ç½®é¡é ­ (generic) -> å ±å‘ŠéŒ¯èª¤
         */
        async function startWebcam() {
            statusMessage.textContent = 'å˜—è©¦å•Ÿå‹•ç›¸æ©Ÿ...';
            snapshotBtn.disabled = true;
            let finalError = null;
            let facingModeUsed = '';

            try {
                // å˜—è©¦ 1: å¾Œç½®é¡é ­ (environment)
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: { ideal: "environment" }, // å„ªå…ˆä½¿ç”¨å¾Œç½®é¡é ­
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                facingModeUsed = 'å¾Œç½®';
            } catch (err1) {
                // å¾Œç½®é¡é ­å¤±æ•—ï¼Œå˜—è©¦å‰ç½®é¡é ­
                finalError = err1;
                console.warn("å¾Œç½®é¡é ­å•Ÿå‹•å¤±æ•—ï¼Œå˜—è©¦å‰ç½®é¡é ­:", err1);
                try {
                    // å˜—è©¦ 2: å‰ç½®é¡é ­ (generic/user)
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    facingModeUsed = 'å‰ç½®';
                    finalError = null; // æˆåŠŸå–å¾—ä¸²æµ
                } catch (err2) {
                    finalError = err2;
                    console.error("å‰ç½®é¡é ­å•Ÿå‹•å¤±æ•—:", err2);
                }
            }
            
            if (stream) {
                // æˆåŠŸè™•ç†
                webcam.srcObject = stream;
                // ç¢ºä¿è¦–è¨Šé–‹å§‹æ’­æ”¾
                await webcam.play().catch(e => {
                    console.error("Webcam play failed, possibly due to user interaction requirement:", e);
                });
                
                webcam.onloadedmetadata = () => {
                    //webcam.play();
                    // åœ¨æ­¤ç¢ºä¿æˆåŠŸå–å¾—çš„ä¸²æµå·²å•Ÿå‹•
                    const track = stream.getVideoTracks()[0];
                    if (track && track.getSettings().facingMode === 'user') {
                        facingModeUsed = 'å‰ç½®';
                    } else if (track && track.getSettings().facingMode === 'environment') {
                        facingModeUsed = 'å¾Œç½®';
                    }
                    
                    statusMessage.textContent = `âœ… ç›¸æ©Ÿå·²å•Ÿå‹• (${facingModeUsed}é¡é ­)ã€‚è«‹å°‡å¡ç‰Œå°æº–é¡é ­ã€‚`;
                    snapshotBtn.disabled = false;
                };
            } else if (finalError) {
                // éŒ¯èª¤è™•ç†
                let errorMessage = `âŒ ç„¡æ³•å­˜å–ç›¸æ©Ÿ: ${finalError.message}`;

                // æª¢æŸ¥æ˜¯å¦ç‚ºå®‰å…¨å”å®šéŒ¯èª¤ (æ‰‹æ©Ÿä¸Šå¸¸è¦‹å•é¡Œ)
                if (finalError.name === "SecurityError" || window.location.protocol !== 'https:') {
                    errorMessage = "ğŸš¨ éŒ¯èª¤ï¼šç›¸æ©Ÿå­˜å–åƒ…å…è¨±åœ¨ **HTTPS** å®‰å…¨é€£ç·šä¸‹é€²è¡Œã€‚è«‹ç¢ºèªæ‚¨çš„ç¶²ç«™ä½¿ç”¨ HTTPSã€‚";
                } else if (finalError.name === "NotAllowedError" || finalError.name === "PermissionDeniedError") {
                    errorMessage = "ğŸš« æ¬Šé™è¢«æ‹’çµ•ã€‚è«‹æª¢æŸ¥æ‚¨çš„ç€è¦½å™¨æˆ–ä½œæ¥­ç³»çµ±è¨­å®šï¼Œå…è¨±æ­¤ç¶²ç«™å­˜å–ç›¸æ©Ÿã€‚";
                }

                statusMessage.textContent = errorMessage;
                console.error("å•Ÿå‹•ç›¸æ©Ÿç¸½çµéŒ¯èª¤:", finalError);
            }
        }

        /**
         * å¾è¦–è¨Šä¸²æµä¸­æ“·å–ä¸€å¹€åœ–åƒä¸¦è½‰æ›ç‚º Base64 (JPEG)
         * @returns {string} Base64 ç·¨ç¢¼çš„ JPEG åœ–åƒæ•¸æ“š (ä¸å«å‰ç¶´)
         */
        function captureSnapshot() {
            const context = canvas.getContext('2d');
            
            // è¨­å®š Canvas å°ºå¯¸èˆ‡è¦–è¨Šå°ºå¯¸ä¸€è‡´
            canvas.width = webcam.videoWidth;
            canvas.height = webcam.videoHeight;

            // åœ¨ Canvas ä¸Šç¹ªè£½è¦–è¨Šå¹€
            context.drawImage(webcam, 0, 0, canvas.width, canvas.height);

            // è½‰æ›ç‚º JPEG Base64 æ ¼å¼
            const dataURL = canvas.toDataURL('image/jpeg', 0.9);
            
            // ç§»é™¤ Base64 å‰ç¶´ 'data:image/jpeg;base64,'
            return dataURL.split(',')[1];
        }

        // --------------------------------------------------------
        // 4. API å‘¼å«é‚è¼¯ (OCR å’Œ Scryfall)
        // --------------------------------------------------------

        /**
         * ä½¿ç”¨ Gemini API åŸ·è¡Œ OCR è¾¨è­˜å¡ç‰Œåç¨±
         * @param {string} base64Image - Base64 ç·¨ç¢¼çš„å¡ç‰Œåœ–åƒ
         * @returns {Promise<string>} è¾¨è­˜å‡ºçš„å¡ç‰Œåç¨±
         */
        async function performOCR(base64Image) {
            const userPrompt = "Identify the card title in this Magic: The Gathering card image. Only return the card title text, nothing else. The card is 63x88mm in size. Return only the English name.";
            const apiKey = ""; // Canvas will inject the key
            const url = API_URL + apiKey;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userPrompt },
                        { inlineData: { mimeType: "image/jpeg", data: base64Image } }
                    ]
                }],
            };
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`Gemini API HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

                if (!text) {
                    throw new Error("API éŸ¿æ‡‰ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„å¡ç‰Œåç¨±ã€‚");
                }
                
                // æ¸…ç†å¤šé¤˜çš„æ¨™é»ç¬¦è™Ÿæˆ–æ›è¡Œ
                const cleanText = text.replace(/[^a-zA-Z0-9\s,\-':.]/g, '').replace(/[\n\r]/g, ' ').trim();
                return cleanText;

            } catch (error) {
                console.error("OCR è¾¨è­˜å¤±æ•—:", error);
                throw new Error("ç„¡æ³•è¾¨è­˜å¡ç‰Œåç¨±ï¼Œè«‹ç¢ºèªå½±åƒæ¸…æ™°åº¦æˆ–å…‰ç·šã€‚");
            }
        }

        /**
         * ä½¿ç”¨ Scryfall API æŸ¥è©¢å¡ç‰Œçš„æ‰€æœ‰ç‰ˆæœ¬
         * @param {string} cardName - å¡ç‰Œåç¨±
         * @returns {Promise<Array<Object>>} å¡ç‰Œç‰ˆæœ¬æ¸…å–®
         */
        async function searchScryfall(cardName) {
            // Scryfall æœå°‹ï¼šä½¿ç”¨åç¨±ä¸¦è¦æ±‚æ‰€æœ‰å°åˆ·ç‰ˆæœ¬ (unique=prints)
            // å°‡å¡ç‰Œåç¨±é€²è¡Œ URL ç·¨ç¢¼
            const query = encodeURIComponent(`!"${cardName}" unique:prints`); 
            const url = `${SCRYFALL_API_URL}${query}`;

            statusMessage.textContent = `æ­£åœ¨ Scryfall æŸ¥è©¢ "${cardName}" çš„æ‰€æœ‰ç‰ˆæœ¬...`;

            try {
                const response = await fetch(url);
                if (response.status === 404) {
                     // 404 è¡¨ç¤ºæ²’æœ‰æ‰¾åˆ°å®Œå…¨åŒ¹é…çš„å¡ç‰Œ
                     throw new Error(`æ‰¾ä¸åˆ°åç¨±ç‚º "${cardName}" çš„å¡ç‰Œã€‚`);
                }
                if (!response.ok) {
                    throw new Error(`Scryfall API æŸ¥è©¢éŒ¯èª¤! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.object === 'list' && data.data.length > 0) {
                    // ç¯©é¸å‡ºæœ‰ tcgplayer_id, ä¸”æ²’æœ‰é‡è¤‡ oracle_id çš„å¡ç‰Œ (ç¢ºä¿åªåˆ—å‡ºä¸»è¦å°åˆ·ç‰ˆæœ¬)
                    // ç”±æ–¼æˆ‘å€‘ç”¨äº† unique:printsï¼Œé€šå¸¸è¿”å›çš„éƒ½æ˜¯æ‰€æœ‰ç‰ˆæœ¬ã€‚
                    return data.data.filter(card => card.tcgplayer_id);
                } else {
                    throw new Error(`Scryfall æœªæ‰¾åˆ° "${cardName}" çš„ä»»ä½•å°åˆ·ç‰ˆæœ¬ã€‚`);
                }

            } catch (error) {
                console.error("Scryfall æŸ¥è©¢å¤±æ•—:", error);
                throw new Error(error.message || "æŸ¥è©¢å¡ç‰Œç‰ˆæœ¬æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
            }
        }

        /**
         * ç”¢ç”Ÿ MTGGoldfish é€£çµä¸¦é¡¯ç¤ºçµæœ
         * @param {Array<Object>} prints - Scryfall è¿”å›çš„å¡ç‰Œç‰ˆæœ¬æ¸…å–®
         */
        function displayResults(cardName, prints) {
            versionOptions.innerHTML = '';
            cardNameDisplay.textContent = `${cardName} (å…± ${prints.length} å€‹ç‰ˆæœ¬)`;

            // ä¾ç…§ç™¼è¡Œæ—¥æœŸé™å†ªæ’åº (æœ€æ–°çš„åœ¨å‰)
            prints.sort((a, b) => new Date(b.released_at) - new Date(a.released_at));

            prints.forEach(card => {
                // 1. å–å¾— MTGGoldfish é€£çµæ‰€éœ€çš„è³‡è¨Š
                const setCode = card.set; // ä¾‹å¦‚: 'mrd'
                const encodedCardName = encodeURIComponent(card.name).replace(/%20/g, '+'); // URL ç·¨ç¢¼ï¼Œç©ºæ ¼è½‰ç‚º '+'

                // 2. æ§‹é€  MTGGoldfish é€£çµ
                // æ ¼å¼: https://www.mtggoldfish.com/price/{SET_CODE}/{CARD_NAME}#{paper/online}
                const mtgGoldfishUrl = `https://www.mtggoldfish.com/price/${setCode.toUpperCase()}/${encodedCardName}#paper`;

                // 3. å»ºç«‹é¡¯ç¤ºå…ƒç´ 
                const releaseDate = card.released_at || 'N/A';
                const rarity = card.rarity.charAt(0).toUpperCase() + card.rarity.slice(1); // é¦–å­—æ¯å¤§å¯«

                const item = document.createElement('a');
                item.href = mtgGoldfishUrl;
                item.target = '_blank'; // é–‹å•Ÿæ–°è¦–çª—
                item.className = 'flex justify-between items-center p-3 bg-gray-700 rounded-lg hover:bg-yellow-600 transition duration-200 shadow-md cursor-pointer';

                item.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-white font-semibold">${card.set_name} (${setCode.toUpperCase()})</span>
                        <span class="text-xs text-gray-300">${rarity} â€¢ ç™¼è¡Œæ—¥æœŸ: ${releaseDate}</span>
                    </div>
                    <span class="text-yellow-400 font-bold ml-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4m-6-2l6-6m0 0v4m0-4h-4" />
                        </svg>
                    </span>
                `;

                versionOptions.appendChild(item);
            });

            statusMessage.textContent = `âœ… æˆåŠŸæ‰¾åˆ° ${prints.length} å€‹ç‰ˆæœ¬ã€‚é»æ“Šé€£çµè·³è½‰è‡³ MTGGoldfishã€‚`;
        }
        
        // --------------------------------------------------------
        // 5. ä¸»è¦æµç¨‹æ§åˆ¶å™¨
        // --------------------------------------------------------

        async function handleScan() {
            if (snapshotBtn.disabled) return;
            
            // é‡ç½®ä»‹é¢
            versionOptions.innerHTML = '<p class="text-gray-500">æ­£åœ¨è™•ç†ä¸­...</p>';
            snapshotBtn.disabled = true;
            loadingOverlay.classList.remove('hidden');

            try {
                // 1. æ“·å–å½±åƒ
                const base64Image = captureSnapshot();
                statusMessage.textContent = 'æ“·å–å½±åƒæˆåŠŸï¼Œæ­£åœ¨é€²è¡Œ OCR è¾¨è­˜...';
                
                // 2. OCR è¾¨è­˜å¡å
                const cardName = await performOCR(base64Image);
                if (!cardName || cardName.length < 3) {
                     throw new Error("OCR è¾¨è­˜çµæœç„¡æ•ˆï¼Œè«‹ç¢ºä¿å¡ç‰Œæ¨™é¡Œæ¸…æ™°å¯è¦‹ã€‚");
                }
                statusMessage.textContent = `âœ¨ è¾¨è­˜å‡ºçš„å¡ç‰Œåç¨±: ${cardName}`;

                // 3. æŸ¥è©¢ Scryfall
                const prints = await searchScryfall(cardName);
                
                // 4. é¡¯ç¤ºçµæœ
                displayResults(cardName, prints);

            } catch (error) {
                const errMsg = error.message || "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚";
                statusMessage.textContent = `âŒ éŒ¯èª¤: ${errMsg}`;
                cardNameDisplay.textContent = 'æŸ¥è©¢çµæœ';
                versionOptions.innerHTML = `<p class="text-red-400 font-medium">${errMsg}</p><p class="text-gray-500 mt-2">è«‹èª¿æ•´å¡ç‰Œä½ç½®ä¸¦å†è©¦ä¸€æ¬¡ã€‚</p>`;
                console.error("ä¸»è¦æƒææµç¨‹éŒ¯èª¤:", error);
            } finally {
                snapshotBtn.disabled = false;
                loadingOverlay.classList.add('hidden');
            }
        }

        // --------------------------------------------------------
        // 6. åˆå§‹åŒ–
        // --------------------------------------------------------

        // ç¶²é è¼‰å…¥å¾Œå•Ÿå‹•ç›¸æ©Ÿ
        window.onload = startWebcam;

        // å°‡ä¸»è¦æµç¨‹å‡½æ•¸æš´éœ²çµ¦ HTML å…ƒç´ 
        window.handleScan = handleScan;

    </script>
</body>

</html>
